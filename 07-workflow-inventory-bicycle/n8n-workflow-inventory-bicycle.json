{
  "name": "소정_n8n_따릉이 재고관리",
  "nodes": [
    {
      "parameters": {
        "rule": {
          "interval": [
            {
              "triggerAtHour": 17
            }
          ]
        }
      },
      "type": "n8n-nodes-base.scheduleTrigger",
      "typeVersion": 1.2,
      "position": [
        -608,
        16
      ],
      "id": "9365c66a-982f-4de4-8317-02035e50c410",
      "name": "Schedule Trigger"
    },
    {
      "parameters": {
        "content": "## 트리거 노드 \n**30분** 주기로 워크플로우를 실행\n",
        "height": 400,
        "width": 208
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -672,
        -96
      ],
      "typeVersion": 1,
      "id": "1bb7531f-0ec5-4393-9396-85c43719b278",
      "name": "Sticky Note"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://kauth.kakao.com/oauth/token",
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "grant_type",
              "value": "authorization_code"
            },
            {
              "name": "client_id",
              "value": "YOUR_KAKAO_CLIENT_ID"
            },
            {
              "name": "redirect_uri",
              "value": "https://n8n.ggplab.xyz/rest/oauth2-credential/callback"
            },
            {
              "name": "code",
              "value": "YOUR_KAKAO_AUTH_CODE"
            },
            {
              "name": "client_secret",
              "value": "YOUR_KAKAO_CLIENT_SECRET"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        848,
        96
      ],
      "id": "87624230-53d9-4e3a-bda1-402057dbe56a",
      "name": "HTTP Request1"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://kapi.kakao.com/v2/api/talk/memo/default/send",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "=Authorization",
              "value": "=Bearer {{ $json.access_token }}"
            }
          ]
        },
        "sendBody": true,
        "contentType": "form-urlencoded",
        "bodyParameters": {
          "parameters": [
            {
              "name": "template_object",
              "value": "={{ JSON.stringify({\n  object_type: \"feed\",\n  content: {\n    title: \"따릉이 요약 리포트\",\n    description: $json.final_report || \"\",\n    image_url: \"https://chatgpt.com/s/m_6927e4f13fdc8191975f677694ab00fc\",\n    image_width: 1200,\n    image_height: 630,\n    link: {\n      web_url: \"https://github.com/sjeong722/n8n_template\",\n      mobile_web_url: \"https://github.com/sjeong722/n8n_template\"\n    }\n  },\n  buttons: [\n    {\n      title: \"워크플로우 확인하기\",\n      link: {\n        web_url: \"https://www.bikeseoul.com/app/stationMap.do\",\n        mobile_web_url: \"https://www.bikeseoul.com/app/stationMap.do\"\n      }\n    }\n  ]\n}) }}"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        1504,
        32
      ],
      "id": "c72bd71e-5a2d-4e35-9175-f9401bb01c26",
      "name": "HTTP Request2"
    },
    {
      "parameters": {
        "content": "## 데이터 수집\n**서울시 열린데이터 공공데이터 실시간 대여정보**",
        "height": 400,
        "width": 192,
        "color": 2
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -448,
        -96
      ],
      "typeVersion": 1,
      "id": "530b3917-f341-4fe2-a0df-cb15a2b9bac4",
      "name": "Sticky Note1"
    },
    {
      "parameters": {
        "content": "## 데이터 전송\n### 카카오톡 발송\n",
        "height": 400,
        "width": 272,
        "color": 5
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        1456,
        -96
      ],
      "typeVersion": 1,
      "id": "05284d51-1c9b-4568-8260-76e157760b29",
      "name": "Sticky Note2"
    },
    {
      "parameters": {
        "url": "http://openapi.seoul.go.kr:8088/YOUR_SEOUL_OPENAPI_KEY/json/bikeList/1/1000",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.3,
      "position": [
        -416,
        16
      ],
      "id": "ef3616fe-7624-4a00-8b92-e617063cdfcf",
      "name": "HTTP Request"
    },
    {
      "parameters": {
        "content": "## 카카오톡 토큰 생성\n### [인가코드] 입력하여 [액세스 토큰] 생성\n",
        "height": 400,
        "width": 288,
        "color": 3
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        768,
        -96
      ],
      "typeVersion": 1,
      "id": "88736975-2750-4666-8ba8-341dd1727199",
      "name": "Sticky Note3"
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "fb8cb7be-0adb-4d2c-8b92-57bc7aee0877",
              "leftValue": "={{ $json.stationName }}",
              "rightValue": "1번출구",
              "operator": {
                "type": "string",
                "operation": "contains"
              }
            }
          ],
          "combinator": "and"
        },
        "options": {}
      },
      "type": "n8n-nodes-base.filter",
      "typeVersion": 2.2,
      "position": [
        -16,
        16
      ],
      "id": "cd30f872-5bf9-4467-9c78-77cafdfd6bd3",
      "name": "Filter"
    },
    {
      "parameters": {
        "fieldToSplitOut": "rentBikeStatus.row",
        "options": {}
      },
      "type": "n8n-nodes-base.splitOut",
      "typeVersion": 1,
      "position": [
        -192,
        16
      ],
      "id": "0195b35c-4d12-4214-9560-8ac092861265",
      "name": "Split Out"
    },
    {
      "parameters": {
        "mode": "combine",
        "combineBy": "combineByPosition",
        "options": {}
      },
      "type": "n8n-nodes-base.merge",
      "typeVersion": 3.2,
      "position": [
        1136,
        32
      ],
      "id": "e7418748-f7ab-4345-9cf5-41cf7342430f",
      "name": "Merge"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "9dac90ee-0c3d-4698-ab5e-4e78c433cc22",
              "name": "access_token",
              "value": "={{ $json.access_token }}",
              "type": "string"
            },
            {
              "id": "115be012-64ac-427c-a493-96027a48d14a",
              "name": "final_report",
              "value": "={{ $json.final_report }}",
              "type": "string"
            },
            {
              "id": "dbbcd951-ba9c-4153-8e42-d65874ad71c8",
              "name": "timestamp",
              "value": "={{ new Date().toISOString() }}",
              "type": "string"
            },
            {
              "id": "de03e21f-44a9-4d0c-9bc2-963e9b6845ed",
              "name": "station_count",
              "value": "={{ ($json.final_report.match(/총\\s*([0-9]+)\\s*개/) || [null, \"\"])[1] }}",
              "type": "number"
            },
            {
              "id": "ab6ff6de-23b9-4698-8d44-b9d76b23026a",
              "name": "avg_bike",
              "value": "={{ ($json.final_report.match(/평균 잔여대수[^0-9]*([0-9.]+)/) || [null, \"\"])[1] }}",
              "type": "number"
            },
            {
              "id": "ace55a3f-ce77-4a71-9aa0-6091229b6226",
              "name": "shortage_area",
              "value": "={{ ($json.final_report.match(/부족 지역(?:은|:)\\s*([^\\n]+)/) || [null, \"\"])[1] }}",
              "type": "string"
            },
            {
              "id": "42879d06-b69a-4adc-8951-c720691c03d4",
              "name": "surplus_area",
              "value": "={{ ($json.final_report.match(/여유 지역(?:은|:)\\s*([^\\n]+)/) || [null, \"\"])[1] }}",
              "type": "string"
            },
            {
              "id": "a04c1c89-1479-45de-80e5-8b00d10b830c",
              "name": "short_summary",
              "value": "=부족: {{ $json.shortage_area || \"없음\" }} / 평균: {{ $json.avg_bike || \"-\" }}대",
              "type": "string"
            },
            {
              "id": "509aa3dd-a81f-4134-a82e-ea1b2feff943",
              "name": "raw_json",
              "value": "={{ JSON.stringify($json) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        1296,
        32
      ],
      "id": "918e5c02-5819-4ae3-84a9-f4d7f439b152",
      "name": "Edit Fields"
    },
    {
      "parameters": {
        "jsCode": "return {\n  final_report: $json.output || $json.text || \"\"\n};"
      },
      "id": "f86fd01a-f230-4f33-a8cf-4cbebe028407",
      "name": "Code(ai_result)",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        576,
        16
      ]
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=다음은 45개 정류소를 분석한 중간 요약 결과이다.\n전체 요약을 아래 기준으로 생성하라.\n\n1) 잔여 대수 부족 문제 발생이 많은 지역  \n2) 잔여 대수가 과도하게 많은 지역  \n3) 시간대별 패턴 (출퇴근, 심야, 평일/주말)  \n4) 배차가 가장 필요한 정류소 상위 5개  \n\n데이터:\n{{ $json[\"output\"] }}\n\n다음은 따릉이 대여소 데이터의 일부(batch)이다.\n이 데이터에서 다음을 요약하라:\n\n1) 총 대여소 개수  \n2) 잔여 대수 기준으로 위험한 정류소(잔여 3대 이하) 목록  \n3) 잔여 대수가 많은 정류소 상위 3개  \n4) 전체 잔여 자전거 평균  \n\n데이터:\n{{JSON.stringify($json)}}",
        "options": {
          "systemMessage": "너는 따릉이 전체 정류소 데이터를 기반으로 통계·패턴을 종합적으로 해석하는 분석가이다."
        }
      },
      "id": "89297b13-37ab-4944-9e82-671e6ae7edaf",
      "name": "Final Summary",
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 3,
      "position": [
        288,
        16
      ]
    },
    {
      "parameters": {
        "content": "## 데이터 처리  1\n\n\n\n\n\n\n\n\n\n\n\n\n\n\n### 하나의 Json 형태의 데이터를 1000개의 item으로 분리\n### 특정 대여소를 지정하여 필터링",
        "height": 400,
        "width": 400,
        "color": 4
      },
      "type": "n8n-nodes-base.stickyNote",
      "position": [
        -240,
        -96
      ],
      "typeVersion": 1,
      "id": "0df33f1c-cb39-4e4f-a2ec-a11abb170ad3",
      "name": "Sticky Note4"
    },
    {
      "parameters": {
        "content": "## 데이터 처리 2\n### 정류소 데이터 기반으로 분석",
        "height": 400,
        "width":
